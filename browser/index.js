import{Relation as oe}from"@wxn0brp/db-core";var Q=class{hidePath=!1;strictSelect=!1;strictACL=!1;noCheckPermissions=!0;permissionDeniedIfNoUser=!0;constructor(e){e&&Object.assign(this,e)}};var P=null;async function z(n){if(typeof window<"u"&&window.crypto?.subtle){let e=await crypto.subtle.digest("SHA-256",new TextEncoder().encode(n));return[...new Uint8Array(e)].map(t=>t.toString(16).padStart(2,"0")).join("")}else return P||(P=await import("crypto")),P.createHash("sha256").update(n).digest("hex")}async function y(n,e){let t=JSON.stringify(e);return n.hidePath?await z(t):t}function O(n,e=[]){let t=[];for(let o in n){let i=n[o];typeof i=="object"?t.push(...O(i,[...e,o])):t.push({path:e,key:o})}return t}async function J(n,e){let t=Object.keys(e.d)[0],o=e.d[t].collection,i={db:await y(n,e.db),c:o,paths:[]};switch(t){case"f":case"find":case"findOne":let r=e.d[t];i.paths.push({filed:O(r.search),p:2});break;case"add":i.paths.push({c:1});break;case"update":case"updateOne":let s=e.d[t];i.paths.push({filed:O(s.search),p:2}),i.paths.push({filed:O(s.updater),p:4});break;case"remove":case"removeOne":i.paths.push({c:8});break;case"updateOneOrAdd":let a=e.d[t];i.paths.push({c:1}),i.paths.push({filed:O(a.search),p:2}),i.paths.push({filed:O(a.updater),p:4});break;case"toggleOne":i.paths.push({c:8}),i.paths.push({c:1});break;case"ensureCollection":case"getCollections":case"issetCollection":case"removeCollection":i.paths.push({c:16});break;default:let l=t;break}return i.paths=(await Promise.all(i.paths.map(async r=>r.filed?await Promise.all(r.filed.map(async s=>{let a=[e.db,o,...Z(s)];return{filed:await y(n,a),path:a,p:r.p}})):r))).flat(),i}function Z(n){let e=!1,t=[];for(let o of n.path)e?t.push(o):o.startsWith("$")?o==="$subset"&&(e=!0):t.push(o);return e?t.push(n.key):n.key.startsWith("$")||t.push(n.key),t}async function F(n,e,t,o){if(!o||!t&&n.permissionDeniedIfNoUser)return!1;let i=await J(n,o),r=async(a,l,p,c=[])=>{let u=await e({field:a,path:l,p,user:t});if(u.granted)return!0;if(!n.strictACL&&u.via==="entity-404"&&c.length>0){let m=await y(n,c.slice(0,-1));return r(m,c.slice(0,-2),p,c.slice(0,-2))}return!1},s=[];for(let a of i.paths){let l,p,c=[],u=[];"c"in a?(l=await y(n,[o.db,i.c]),p=a.c,u=[o.db,i.c],c=[o.db]):(l=a.filed,p=a.p,u=a.path,c=a.path);let m=await r(l,u,p,c);s.push(m)}return s.every(a=>a)}async function A(n,e,t,o){if(!t&&n.permissionDeniedIfNoUser)return!1;let{path:i,search:r,relations:s,select:a}=o.r,l=async(c,u,m=[])=>{let w=await e({field:c,path:u,p:2,user:t});if(w.granted)return!0;if(!n.strictACL&&w.via==="entity-404"&&m.length>0){let B=await y(n,m.slice(0,-1));return l(B,m.slice(0,-2),m.slice(0,-2))}return!1};if(!await l(await y(n,i),i,i))return!1;let p=O(r||{});for(let c of p){let u=[...i,...c.path,c.key];if(!await l(await y(n,u),u,u))return!1}if(a)for(let c of a){let u=[...i,c];if(!await l(await y(n,u),u,u))return!1}if(s)for(let c in s){let u=s[c];if(!await A(n,e,t,{r:u}))return!1}return!0}function b(n,e){if(Array.isArray(e))return!n.strictSelect&&e.length===0?void 0:e;if(typeof e=="object"){let t=Object.keys(e);return!n.strictSelect&&t.length===0?void 0:t.filter(o=>!!e[o])}else return n.strictSelect?[]:void 0}function X(n,e){e.select=b(n,e.select)}function E(n,e){let t=e.path[0];if(!t||!n.dbInstances[t])return{err:!0,msg:`Invalid query - db "${t}" not found`,c:400};if(e.relations)for(let o of Object.values(e.relations)){let i=E(n,o);if(i.err)return i}return{err:!1}}async function U(n,e,t){let o=E(n,e.r);if(o.err)return o;if(!n.config.noCheckPermissions&&!await A(n.config,n.permValidFn,t,e))return{err:!0,msg:"Permission denied",c:403};let i=e.r;X(n.config,i);let{path:r,search:s,relations:a,select:l}=i;return i.many?await n.relation.find(r,s,a,l,i.options):await n.relation.findOne(r,s,a,l)}var _=class{constructor(e){this.resolver=e}};async function k(n,e,t){if(!e.db||!n.dbInstances[e.db])return{err:!0,msg:`Invalid query - db "${e.db||"undefined"}" not found`,c:400};let o=n.dbInstances[e.db];if(o instanceof _)return await o.resolver(e,t);let i=Object.keys(e.d)[0];if(!n.config.noCheckPermissions&&!await F(n.config,n.permValidFn,t,e))return{err:!0,msg:"Permission denied",c:403};if(i==="find"){let r=e.d[i],s=b(n.config,r.fields||r.select||{});return s&&typeof s=="object"&&Object.keys(s).length!==0&&(r.searchOpts={...r.searchOpts,select:s}),o.find(r.collection,r.search,r.options||{},r.searchOpts)}else if(i==="findOne"||i==="f"){let r=e.d[i],s=b(n.config,r.fields||r.select||{});return s&&typeof s=="object"&&Object.keys(s).length!==0&&(r.searchOpts={...r.searchOpts,select:s}),o.findOne(r.collection,r.search,r.searchOpts)}else if(i==="add"){let r=e.d[i];return o.add(r.collection,r.data,r.id_gen??!0)}else if(i==="update"){let r=e.d[i];return o.update(r.collection,r.search,r.updater)}else if(i==="updateOne"){let r=e.d[i];return o.updateOne(r.collection,r.search,r.updater)}else if(i==="remove"){let r=e.d[i];return o.remove(r.collection,r.search)}else if(i==="removeOne"){let r=e.d[i];return o.removeOne(r.collection,r.search)}else if(i==="updateOneOrAdd"){let r=e.d[i],s={};return r.add_arg&&(s.add_arg=r.add_arg),r.id_gen&&(s.id_gen=r.id_gen),o.updateOneOrAdd(r.collection,r.search,r.updater,s)}else if(i==="toggleOne"){let r=e.d[i];return o.toggleOne(r.collection,r.search,r.data)}else if(i==="removeCollection"){let r=e.d[i];return o.removeCollection(r.collection)}else if(i==="ensureCollection"){let r=e.d[i];return o.ensureCollection(r.collection)}else if(i==="issetCollection"){let r=e.d[i];return o.issetCollection(r.collection)}else{if(i==="getCollections")return o.getCollections();{let r=i;throw new Error("Unknown operation "+r)}}}var V=class{log(e){let t="";if(e.loggerName&&(t+=`[${e.loggerName}] `),t+="["+e.timestamp+"] ",t+="["+e.level.toUpperCase()+"]",e.level==="DEBUG"){let o=e.data.findIndex(i=>typeof i=="object");if(o>=0){let i=e.data.slice(0,o),r=e.data.slice(o);console.log(t,...i);for(let s of r)typeof s=="object"?console.dir(s,{depth:null}):console.log(s);console.log("[DEBUG];")}else console.log(t,...e.data)}else console.log(t,...e.data)}};var h;(function(n){n[n.ERROR=0]="ERROR",n[n.WARN=1]="WARN",n[n.INFO=2]="INFO",n[n.DEBUG=3]="DEBUG"})(h||(h={}));var L=class{transports;loggerName;logLevel;constructor(e={}){if(this.transports=e.transports??[new V],this.loggerName=e.loggerName??"",e.logLevel){let t=e.logLevel.toUpperCase();typeof h[t]=="number"?this.logLevel=h[t]:this.logLevel=h.ERROR}else this.logLevel=h.ERROR}createEntry(e,t){return{level:e,timestamp:new Date().toISOString(),data:t,loggerName:this.loggerName}}async log(e,t){if(e>this.logLevel)return;let o=this.createEntry(h[e],t);for(let i of this.transports)await i.log(o)}debug(...e){return this.log(h.DEBUG,e)}info(...e){return this.log(h.INFO,e)}warn(...e){return this.log(h.WARN,e)}error(...e){return this.log(h.ERROR,e)}};var Y=new L({loggerName:"VQL"}),g=Y;function x(n,e){if(typeof n=="object"&&!Array.isArray(n)&&n!==null&&"__"in n){let t=n.__;return e[t]??n}if(typeof n=="string")return n.startsWith("$")?e[n.slice(1)]??n:n;if(Array.isArray(n))return n.map(t=>x(t,e));if(typeof n=="object"&&n!==null){let t={};for(let o in n)t[o]=x(n[o],e);return t}return n}function D(n,e){return n.var={_me:e?.id||e?._id||e,_user:e,_now:Date.now(),_nowShort:Math.floor(Date.now()/1e3),__now:Date.now().toString(),__nowShort:Math.floor(Date.now()/1e3).toString(),...n.var||{}},n=x(n,n.var),delete n.var,n}function f(n="Bad query"){return{err:!0,msg:n,c:400}}function d(n,e=!0){return typeof n=="object"&&n!==null&&!Array.isArray(n)&&(!e||Object.keys(n).length!==0)}function j(n){return"r"in n&&d(n.r)||"db"in n&&typeof n.db=="string"&&d(n.d)?!0:f("Invalid VQL query structure. Must contain 'r' or 'db' and 'd'.")}function T(n){if(!d(n,!1))return f("The 'relations' property must be an object.");for(let e in n){let t=n[e];if(!d(t))return f(`Relation '${e}' must be an object.`);if(!("path"in t)||!Array.isArray(t.path)||t.path.length!==2)return f(`Relation '${e}' must have a 'path' property with an array of two strings.`);if("search"in t&&!d(t.search,!1))return f(`Relation '${e}' has an invalid 'search' property; it must be an object.`);if("many"in t&&typeof t.many!="boolean")return f(`Relation '${e}' has an invalid 'many' property; it must be a boolean.`);if("options"in t&&!d(t.options,!1))return f(`Relation '${e}' has an invalid 'options' property; it must be an object.`);if("select"in t&&!Array.isArray(t.select))return f(`Relation '${e}' has an invalid 'select' property; it must be an array.`);if("relations"in t){let o=T(t.relations);if(o!==!0)return o}}return!0}function q(n){let{r:e}=n;if(!("path"in e)||!Array.isArray(e.path)||e.path.length!==2)return f("Relation query 'r' must have a 'path' property with an array of two strings.");if(!d(e.search,!1))return f("Relation query 'r.search' must be an object.");if(!d(e.relations,!1))return f("Relation query 'r' must have a 'relations' object.");let t=T(e.relations);return t!==!0?t:"many"in e&&typeof e.many!="boolean"?f("Relation query 'r.many' must be a boolean."):"options"in e&&!d(e.options,!1)?f("Relation query 'r.options' must be an object."):"select"in e&&typeof e.select!="object"?f("Relation query 'r.select' must be an object or an array."):!0}function ee(n){let{d:e}=n,t=Object.keys(e)[0],o=e[t];if(t==="getCollections")return!0;if(typeof o.collection!="string"||o.collection.trim()==="")return f(`CRUD operation '${t}' must specify a non-empty 'collection' string.`);if(t==="issetCollection"||t==="ensureCollection"||t==="removeCollection")return!0;if(t==="add"){let r=e.add;return d(r.data)?"id_gen"in r&&typeof r.id_gen!="boolean"?f("'add' operation 'id_gen' property must be a boolean."):!0:f("'add' operation requires a 'data' object.")}if(t==="find"){let r=e.find;return"search"in r&&!d(r.search,!1)?f("'find' operation 'search' property must be an object."):"limit"in r&&typeof r.limit!="number"?f("'find' operation 'limit' property must be a number."):"fields"in r&&!d(r.fields,!1)&&!Array.isArray(r.fields)?f("'find' operation 'fields' property must be an object or an array."):"select"in r&&!d(r.select,!1)&&!Array.isArray(r.select)?f("'find' operation 'select' property must be an object or an array."):"options"in r&&!d(r.options,!1)?f("'find' operation 'options' property must be an object."):"searchOpts"in r&&!d(r.searchOpts,!1)?f("'find' operation 'searchOpts' property must be an object."):!0}if(t==="findOne"||t==="f"){let r=e.findOne||e.f;return d(r.search,!1)?"fields"in r&&!d(r.fields,!1)&&!Array.isArray(r.fields)?f(`'${t}' operation 'fields' property must be an object or an array.`):"select"in r&&!d(r.select,!1)&&!Array.isArray(r.select)?f(`'${t}' operation 'select' property must be an object or an array.`):"searchOpts"in r&&!d(r.searchOpts,!1)?f(`'${t}' operation 'searchOpts' property must be an object.`):!0:f(`'${t}' operation requires a 'search' object.`)}if(t==="remove"||t==="removeOne"){let r=e.remove||e.removeOne;return d(r.search,!1)?!0:f(`'${t}' operation requires a 'search' object.`)}if(t==="update"||t==="updateOne"){let r=e.update||e.updateOne;return d(r.search,!1)?d(r.updater,!1)?!0:f(`'${t}' operation requires an 'updater' object.`):f(`'${t}' operation requires a 'search' object.`)}if(t==="updateOneOrAdd"){let r=e.updateOneOrAdd;return d(r.search,!1)?d(r.updater,!1)?"add_arg"in r&&!d(r.add_arg,!1)?f("'updateOneOrAdd' operation 'add_arg' property must be an object."):"id_gen"in r&&typeof r.id_gen!="boolean"?f("'updateOneOrAdd' operation 'id_gen' property must be a boolean."):!0:f("'updateOneOrAdd' operation requires an 'updater' object."):f("'updateOneOrAdd' operation requires a 'search' object.")}if(t==="toggleOne"){let r=e.toggleOne;return d(r.search,!1)?"data"in r&&!d(r.data,!1)?f("'toggleOne' operation 'data' property must be an object."):!0:f("'toggleOne' operation requires a 'search' object.")}let i=t;return f(`Unknown or invalid CRUD operation: '${t}'`)}function $(n){return"r"in n&&d(n.r)?q(n):"d"in n&&d(n.d)?ee(n):f("Query must contain a valid 'r' (relation) or 'd' (database) property.")}function I(n){let e={},t=[],o="",i=!1,r=!1,s=0;for(let a=0;a<n.length;a++){let l=n[a];if(r)o+=l,r=!1;else if(l==="\\")r=!0;else if(!i&&(l==="{"||l==="["))s++,o+=l;else if(!i&&(l==="}"||l==="]"))s--,o+=l,s===0&&(t.push(o),o="");else if(!s&&(l==="'"||l==='"'||l==="`"))i===l?(i=!1,t.push('"'+o+'"'),o=""):typeof i=="boolean"?i=l:o+=l;else if(!i&&(l===" "||l==="="||l==="<"||l===">")){if(o!==""){if(l==="<"||l===">"){let p=l===">"?"gt":"lt";a<n.length-1&&n[a+1]==="="&&(p+="e",a++);let c=o.split(".");if(c.length>1){let u=c.shift(),m="$"+p;c.unshift(m),c.unshift(u),o=c.join(".")}else o="$"+p+"."+o}t.push(o),o=""}}else o+=l}o!==""&&t.push(o);for(let a=0;a<t.length;a+=2){let l=t[a],p=t[a+1]??!0;if(typeof p=="string"){let c=p.trim();if(c==="")p=!0;else if(/^".*"$/.test(c))p=c.slice(1,-1);else if(c.toLowerCase()==="true")p=!0;else if(c.toLowerCase()==="false")p=!1;else if(!isNaN(Number(c)))p=Number(c);else if(c.startsWith("{")&&c.endsWith("}")||c.startsWith("[")&&c.endsWith("]"))try{p=JSON.parse(c)}catch{}}e[l]=p}return e}var S={"-":"remove","+":"add","~":"update","?":"updateOneOrAdd","^":"toggleOne"},te=["add","find","findOne","update","updateOne","remove","removeOne","updateOneOrAdd","toggleOne","ensureCollection","issetCollection"];function K(n){let e=n.split(`
`).map(s=>s.trim()).filter(s=>s.length>0&&!s.startsWith("#")&&!s.startsWith("//")).join(" ").split(/\s+/).filter(Boolean);if(e.length<2)throw new Error("Invalid query");if(e.length===2&&e[1]==="getCollections")return{db:e[0],op:"getCollections",collection:"",body:""};if(e.length===2&&/^[A-Za-z]/.test(e[0])){let s=N(e[1]);return{db:e[0],op:s.op,collection:s.collection,body:""}}if(e.length===3&&/^[A-Za-z0-9_-]+$/.test(e[2]))return{db:e[0],op:e[1],collection:e[2],body:""};if(e.length>3&&te.includes(e[1]))return{db:e[0],op:e[1],collection:e[2],body:e.slice(3).join(" ")};let t=e.shift(),o="find",i="",r="";if(["!","-","+","~","?","^"].some(s=>e[0].includes(s))||[".",":","{"].some(s=>e[1].includes(s))){let s=e.shift(),a=N(s);o=a.op,i=a.collection}else o=e.shift(),i=e.shift();return r=e.join(" "),{db:t,op:o,collection:i,body:r}}function N(n){let e=n[0],t=n[n.length-1],o="find",i=n;return S[e]&&(o=S[e],i=i.slice(1)),t==="!"&&(o!=="add"&&(o+="One"),i=i.slice(0,-1)),{op:o,collection:i}}function R(n,e=[]){return Object.entries(n).reduce((t,[o,i])=>{let r=[...e,o];return i?typeof i=="object"&&i!==null&&!Array.isArray(i)?[...t,...R(i,r)]:[...t,r]:t},[])}function W(n,e,t,o){return"relations"in o?re(n,t,o):ne(n,e,t,o)}function re(n,e,t){let o={};for(let i in t.relations){let r=t.relations[i];o[i]={path:[r.db||n,r.c||i],...r},delete o[i].db,delete o[i].c}return"select"in t&&(t.select=R(t.select)),{r:{path:[n,e],...t,relations:o}}}function ne(n,e,t,o){return o.fields&&!o.select&&(o.select=o.fields,delete o.fields),"select"in o&&(o.select=[...new Set(R(o.select).map(i=>i[0]).flat())]),{db:n,d:{[e]:{collection:t,...o}}}}var M={s:"search",f:"fields",o:"options",r:"relations",d:"data",e:"select",u:"updater"};function v(n){let{db:e,op:t,collection:o,body:i}=K(n),r=I(i);for(let s of Object.keys(r)){let a=s.split(".");if(a.length===1)continue;let l=r;for(let p=0;p<a.length;p++){let c=a[p];if(p<a.length-1){if(!(c in l)){let u=a[p+1],m=/^\d+$/.test(u);l[c]=m?[]:{}}l=l[c]}else l[c]=r[s],delete r[s]}}for(let s in M)s in r&&(r[M[s]]=r[s],delete r[s]);return(t==="find"||t==="findOne")&&!("search"in r)&&(r.search={}),(t==="update"||t==="remove")&&!("updater"in r)&&"data"in r&&(r.updater=r.data,delete r.data),W(e,t,o,r)}var C=class{constructor(e,t=new Q,o=async()=>({granted:!0,via:""})){this.dbInstances=e;this.permValidFn=o;this.relation=new oe(e),this.config=t instanceof Q?t:new Q(t)}relation;config;async execute(e,t={_id:"null-null-null"}){let o=this._preProcessQuery(e,t);return"err"in o?o.err:await this._runQuery(o.query,t)}_preProcessQuery(e,t){let{query:o,err:i}=this._parseQuery(e);if(i)return{err:i};let r=j(o);if(r!==!0)return g.warn("Raw validation failed:",r),{err:r};let s=D(o,t);g.debug("Executed sheet (expanded query):",s);let a=$(s);return a!==!0?(g.warn("VQL validation failed:",a),{err:a}):{query:s}}_parseQuery(e){if(typeof e=="string"||"query"in e){g.info("Incoming string query");let t=typeof e=="string"?e:e.query,o=typeof e=="string"?null:e.var;g.debug(t);try{e=v(t),g.debug("transformed query: ",e)}catch(i){return g.error("Error parsing string query: ",{error:i,msg:i.message}),{err:{err:!0,c:400,msg:`String query parsing error: ${i.message}`}}}o&&(e={...e,var:o}),g.debug("Final string query: ",e)}else g.info("Incoming object query"),g.debug("Raw query: ",e);return{query:e}}async _runQuery(e,t){return"r"in e?await U(this,e,t):"d"in e?await k(this,e,t):{err:!0,msg:"Invalid query",c:400}}};import ie from"@wxn0brp/db-core/helpers/CollectionManager";import G from"@wxn0brp/db-core/utils/updateFindObject";var se=["ensureCollection","issetCollection","getCollections","removeCollection","add","find","findOne","update","updateOne","updateOneOrAdd","toggleOne","remove","removeOne"];function ae(n,e=!1){let t=i=>{if(!i)throw new Error("Unimplemented method");return i},o={meta:n.meta??{type:"api",version:"0.0.1"}};o.c=i=>new ie(o,i);for(let i of se)o[i]=(...r)=>t(n[i])(...r);return e&&(o.find=async(i,r,s,a,l)=>{let p=await t(n.find)(i,r,s,a,l);return s?.reverse&&p.reverse(),s?.limit!==-1&&p.length>s?.limit&&(p=p.slice(0,s?.limit)),p=p.map(c=>G(c,a||{})),p},o.findOne=async(i,r,s,a)=>{let l=await t(n.findOne)(i,r,s,a);return typeof l!="object"?l:G(l,a||{})}),o}function le(n,e,t={}){let o=t.path||"/VQL",i=t.getUser||(()=>({}));n.post(o,async(r,s)=>{try{let a=await i(r),l=await e.execute(r.body.query,a);return l&&l.err?l:{err:!1,result:l}}catch(a){return s.status(500),{err:!0,msg:a.message}}}),t.dev&&n.get(o+"-query",(r,s)=>{try{return s.json(v(r.query?.query||""))}catch(a){return s.status(500),{err:!0,msg:a.message}}})}function ce(n){return async e=>n.hasAccess(e.user.id,e.field,e.p)}var bt=C;export{le as FF_VQL,Q as VQLConfig,h as VQLLogLevel,g as VQLLogger,C as VQLProcessor,ce as createGwValidFn,ae as createValtheraAdapter,bt as default};
