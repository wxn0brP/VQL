import{Relation as oe}from"@wxn0brp/db-core";var Q=class{hidePath=!1;strictSelect=!1;strictACL=!1;noCheckPermissions=!0;permissionDeniedIfNoUser=!0;constructor(e){e&&Object.assign(this,e)}};var F=null;async function z(r){if(typeof window<"u"&&window.crypto?.subtle){let e=await crypto.subtle.digest("SHA-256",new TextEncoder().encode(r));return[...new Uint8Array(e)].map(t=>t.toString(16).padStart(2,"0")).join("")}else return F||(F=await import("crypto")),F.createHash("sha256").update(r).digest("hex")}async function y(r,e){let t=JSON.stringify(e);return r.hidePath?await z(t):t}function O(r,e=[]){let t=[];for(let o in r){let s=r[o];typeof s=="object"?t.push(...O(s,[...e,o])):t.push({path:e,key:o})}return t}async function J(r,e){let t=Object.keys(e.d)[0],o=e.d[t].collection,s={db:await y(r,e.db),c:o,paths:[]};switch(t){case"f":case"find":case"findOne":let n=e.d[t];s.paths.push({filed:O(n.search),p:2});break;case"add":s.paths.push({c:1});break;case"update":case"updateOne":let i=e.d[t];s.paths.push({filed:O(i.search),p:2}),s.paths.push({filed:O(i.updater),p:4});break;case"remove":case"removeOne":s.paths.push({c:8});break;case"updateOneOrAdd":let a=e.d[t];s.paths.push({c:1}),s.paths.push({filed:O(a.search),p:2}),s.paths.push({filed:O(a.updater),p:4});break;case"toggleOne":s.paths.push({c:8}),s.paths.push({c:1});break;case"ensureCollection":case"getCollections":case"issetCollection":case"removeCollection":s.paths.push({c:16});break;default:let l=t;break}return s.paths=(await Promise.all(s.paths.map(async n=>n.filed?await Promise.all(n.filed.map(async i=>{let a=[e.db,o,...Z(i)];return{filed:await y(r,a),path:a,p:n.p}})):n))).flat(),s}function Z(r){let e=!1,t=[];for(let o of r.path)e?t.push(o):o.startsWith("$")?o==="$subset"&&(e=!0):t.push(o);return e?t.push(r.key):r.key.startsWith("$")||t.push(r.key),t}async function w(r,e,t,o){if(!o||!t&&r.permissionDeniedIfNoUser)return!1;let s=await J(r,o),n=async(a,l,f,c=[])=>{let u=await e({field:a,path:l,p:f,user:t});if(u.granted)return!0;if(!r.strictACL&&u.reason==="entity-404"&&c.length>0){let m=await y(r,c.slice(0,-1));return n(m,c.slice(0,-2),f,c.slice(0,-2))}return!1},i=[];for(let a of s.paths){let l,f,c=[],u=[];"c"in a?(l=await y(r,[o.db,s.c]),f=a.c,u=[o.db,s.c],c=[o.db]):(l=a.filed,f=a.p,u=a.path,c=a.path);let m=await n(l,u,f,c);i.push(m)}return i.every(a=>a)}async function P(r,e,t,o){if(!t&&r.permissionDeniedIfNoUser)return!1;let{path:s,search:n,relations:i,select:a}=o.r,l=async(c,u,m=[])=>{let x=await e({field:c,path:u,p:2,user:t});if(x.granted)return!0;if(!r.strictACL&&x.reason==="entity-404"&&m.length>0){let B=await y(r,m.slice(0,-1));return l(B,m.slice(0,-2),m.slice(0,-2))}return!1};if(!await l(await y(r,s),s,s))return!1;let f=O(n||{});for(let c of f){let u=[...s,...c.path,c.key];if(!await l(await y(r,u),u,u))return!1}if(a)for(let c of a){let u=[...s,c];if(!await l(await y(r,u),u,u))return!1}if(i)for(let c in i){let u=i[c];if(!await P(r,e,t,{r:u}))return!1}return!0}function V(r,e){if(Array.isArray(e))return!r.strictSelect&&e.length===0?void 0:e;if(typeof e=="object"){let t=Object.keys(e);return!r.strictSelect&&t.length===0?void 0:t.filter(o=>!!e[o])}else return r.strictSelect?[]:void 0}function X(r,e){e.select=V(r,e.select)}function E(r,e){let t=e.path[0];if(!t||!r.dbInstances[t])return{err:!0,msg:`Invalid query - db "${t}" not found`,c:400};if(e.relations)for(let o of Object.values(e.relations)){let s=E(r,o);if(s.err)return s}return{err:!1}}async function D(r,e,t,o){let s=E(r,e.r);if(s.err)return s;if(!o.noCheckPermissions&&!await P(o,r.permValidFn,t,e))return{err:!0,msg:"Permission denied",c:403};let n=e.r;X(o,n);let{path:i,search:a,relations:l,select:f}=n;return n.many?await r.relation.find(i,a,l,f,n.options):await r.relation.findOne(i,a,l,f)}var b=class{constructor(e){this.resolver=e}};async function U(r,e,t,o){if(!e.db||!r.dbInstances[e.db])return{err:!0,msg:`Invalid query - db "${e.db||"undefined"}" not found`,c:400};let s=r.dbInstances[e.db];if(s instanceof b)return await s.resolver(e,t);let n=Object.keys(e.d)[0];if(!o.noCheckPermissions&&!await w(o,r.permValidFn,t,e))return{err:!0,msg:"Permission denied",c:403};if(n==="find"){let i=e.d[n],a=V(o,i.fields||i.select||{});return a&&typeof a=="object"&&Object.keys(a).length!==0&&(i.searchOpts={...i.searchOpts,select:a}),s.find(i.collection,i.search,i.options||{},i.searchOpts)}else if(n==="findOne"||n==="f"){let i=e.d[n],a=V(o,i.fields||i.select||{});return a&&typeof a=="object"&&Object.keys(a).length!==0&&(i.searchOpts={...i.searchOpts,select:a}),s.findOne(i.collection,i.search,i.searchOpts)}else if(n==="add"){let i=e.d[n];return s.add(i.collection,i.data,i.id_gen??!0)}else if(n==="update"){let i=e.d[n];return s.update(i.collection,i.search,i.updater)}else if(n==="updateOne"){let i=e.d[n];return s.updateOne(i.collection,i.search,i.updater)}else if(n==="remove"){let i=e.d[n];return s.remove(i.collection,i.search)}else if(n==="removeOne"){let i=e.d[n];return s.removeOne(i.collection,i.search)}else if(n==="updateOneOrAdd"){let i=e.d[n],a={};return i.add_arg&&(a.add_arg=i.add_arg),i.id_gen&&(a.id_gen=i.id_gen),s.updateOneOrAdd(i.collection,i.search,i.updater,a)}else if(n==="toggleOne"){let i=e.d[n];return s.toggleOne(i.collection,i.search,i.data)}else if(n==="removeCollection"){let i=e.d[n];return s.removeCollection(i.collection)}else if(n==="ensureCollection"){let i=e.d[n];return s.ensureCollection(i.collection)}else if(n==="issetCollection"){let i=e.d[n];return s.issetCollection(i.collection)}else{if(n==="getCollections")return s.getCollections();{let i=n;throw new Error("Unknown operation "+i)}}}var _=class{log(e){let t="";if(e.loggerName&&(t+=`[${e.loggerName}] `),t+="["+e.timestamp+"] ",t+="["+e.level.toUpperCase()+"]",e.level==="DEBUG"){let o=e.data.findIndex(s=>typeof s=="object");if(o>=0){let s=e.data.slice(0,o),n=e.data.slice(o);console.log(t,...s);for(let i of n)typeof i=="object"?console.dir(i,{depth:null}):console.log(i);console.log("[DEBUG];")}else console.log(t,...e.data)}else console.log(t,...e.data)}};var h;(function(r){r[r.ERROR=0]="ERROR",r[r.WARN=1]="WARN",r[r.INFO=2]="INFO",r[r.DEBUG=3]="DEBUG"})(h||(h={}));var v=class{transports;loggerName;logLevel;constructor(e={}){if(this.transports=e.transports??[new _],this.loggerName=e.loggerName??"",e.logLevel){let t=e.logLevel.toUpperCase();typeof h[t]=="number"?this.logLevel=h[t]:this.logLevel=h.ERROR}else this.logLevel=h.ERROR}createEntry(e,t){return{level:e,timestamp:new Date().toISOString(),data:t,loggerName:this.loggerName}}async log(e,t){if(e>this.logLevel)return;let o=this.createEntry(h[e],t);for(let s of this.transports)await s.log(o)}debug(...e){return this.log(h.DEBUG,e)}info(...e){return this.log(h.INFO,e)}warn(...e){return this.log(h.WARN,e)}error(...e){return this.log(h.ERROR,e)}};var Y=new v({loggerName:"VQL"}),g=Y;function A(r,e){if(typeof r=="object"&&!Array.isArray(r)&&r!==null&&"__"in r){let t=r.__;return e[t]??r}if(typeof r=="string")return r.startsWith("$")?e[r.slice(1)]??r:r;if(Array.isArray(r))return r.map(t=>A(t,e));if(typeof r=="object"&&r!==null){let t={};for(let o in r)t[o]=A(r[o],e);return t}return r}function k(r,e){return r.var={_me:e?.id||e?._id||e,_user:e,_now:Date.now(),_nowShort:Math.floor(Date.now()/1e3),__now:Date.now().toString(),__nowShort:Math.floor(Date.now()/1e3).toString(),...r.var||{}},r=A(r,r.var),delete r.var,r}function p(r="Bad query"){return{err:!0,msg:r,c:400}}function d(r,e=!0){return typeof r=="object"&&r!==null&&!Array.isArray(r)&&(!e||Object.keys(r).length!==0)}function T(r){return"r"in r&&d(r.r)||"db"in r&&typeof r.db=="string"&&d(r.d)?!0:p("Invalid VQL query structure. Must contain 'r' or 'db' and 'd'.")}function j(r){if(!d(r,!1))return p("The 'relations' property must be an object.");for(let e in r){let t=r[e];if(!d(t))return p(`Relation '${e}' must be an object.`);if(!("path"in t)||!Array.isArray(t.path)||t.path.length!==2)return p(`Relation '${e}' must have a 'path' property with an array of two strings.`);if("search"in t&&!d(t.search,!1))return p(`Relation '${e}' has an invalid 'search' property; it must be an object.`);if("many"in t&&typeof t.many!="boolean")return p(`Relation '${e}' has an invalid 'many' property; it must be a boolean.`);if("options"in t&&!d(t.options,!1))return p(`Relation '${e}' has an invalid 'options' property; it must be an object.`);if("select"in t&&!Array.isArray(t.select))return p(`Relation '${e}' has an invalid 'select' property; it must be an array.`);if("relations"in t){let o=j(t.relations);if(o!==!0)return o}}return!0}function q(r){let{r:e}=r;if(!("path"in e)||!Array.isArray(e.path)||e.path.length!==2)return p("Relation query 'r' must have a 'path' property with an array of two strings.");if(!d(e.search,!1))return p("Relation query 'r.search' must be an object.");if(!d(e.relations,!1))return p("Relation query 'r' must have a 'relations' object.");let t=j(e.relations);return t!==!0?t:"many"in e&&typeof e.many!="boolean"?p("Relation query 'r.many' must be a boolean."):"options"in e&&!d(e.options,!1)?p("Relation query 'r.options' must be an object."):"select"in e&&typeof e.select!="object"?p("Relation query 'r.select' must be an object or an array."):!0}function ee(r){let{d:e}=r,t=Object.keys(e)[0],o=e[t];if(t==="getCollections")return!0;if(typeof o.collection!="string"||o.collection.trim()==="")return p(`CRUD operation '${t}' must specify a non-empty 'collection' string.`);if(t==="issetCollection"||t==="ensureCollection"||t==="removeCollection")return!0;if(t==="add"){let n=e.add;return d(n.data)?"id_gen"in n&&typeof n.id_gen!="boolean"?p("'add' operation 'id_gen' property must be a boolean."):!0:p("'add' operation requires a 'data' object.")}if(t==="find"){let n=e.find;return"search"in n&&!d(n.search,!1)?p("'find' operation 'search' property must be an object."):"limit"in n&&typeof n.limit!="number"?p("'find' operation 'limit' property must be a number."):"fields"in n&&!d(n.fields,!1)&&!Array.isArray(n.fields)?p("'find' operation 'fields' property must be an object or an array."):"select"in n&&!d(n.select,!1)&&!Array.isArray(n.select)?p("'find' operation 'select' property must be an object or an array."):"options"in n&&!d(n.options,!1)?p("'find' operation 'options' property must be an object."):"searchOpts"in n&&!d(n.searchOpts,!1)?p("'find' operation 'searchOpts' property must be an object."):!0}if(t==="findOne"||t==="f"){let n=e.findOne||e.f;return d(n.search,!1)?"fields"in n&&!d(n.fields,!1)&&!Array.isArray(n.fields)?p(`'${t}' operation 'fields' property must be an object or an array.`):"select"in n&&!d(n.select,!1)&&!Array.isArray(n.select)?p(`'${t}' operation 'select' property must be an object or an array.`):"searchOpts"in n&&!d(n.searchOpts,!1)?p(`'${t}' operation 'searchOpts' property must be an object.`):!0:p(`'${t}' operation requires a 'search' object.`)}if(t==="remove"||t==="removeOne"){let n=e.remove||e.removeOne;return d(n.search,!1)?!0:p(`'${t}' operation requires a 'search' object.`)}if(t==="update"||t==="updateOne"){let n=e.update||e.updateOne;return d(n.search,!1)?d(n.updater,!1)?!0:p(`'${t}' operation requires an 'updater' object.`):p(`'${t}' operation requires a 'search' object.`)}if(t==="updateOneOrAdd"){let n=e.updateOneOrAdd;return d(n.search,!1)?d(n.updater,!1)?"add_arg"in n&&!d(n.add_arg,!1)?p("'updateOneOrAdd' operation 'add_arg' property must be an object."):"id_gen"in n&&typeof n.id_gen!="boolean"?p("'updateOneOrAdd' operation 'id_gen' property must be a boolean."):!0:p("'updateOneOrAdd' operation requires an 'updater' object."):p("'updateOneOrAdd' operation requires a 'search' object.")}if(t==="toggleOne"){let n=e.toggleOne;return d(n.search,!1)?"data"in n&&!d(n.data,!1)?p("'toggleOne' operation 'data' property must be an object."):!0:p("'toggleOne' operation requires a 'search' object.")}let s=t;return p(`Unknown or invalid CRUD operation: '${t}'`)}function $(r){return"r"in r&&d(r.r)?q(r):"d"in r&&d(r.d)?ee(r):p("Query must contain a valid 'r' (relation) or 'd' (database) property.")}function I(r){let e={},t=[],o="",s=!1,n=!1,i=0;for(let a=0;a<r.length;a++){let l=r[a];if(n)o+=l,n=!1;else if(l==="\\")n=!0;else if(!s&&(l==="{"||l==="["))i++,o+=l;else if(!s&&(l==="}"||l==="]"))i--,o+=l,i===0&&(t.push(o),o="");else if(!i&&(l==="'"||l==='"'||l==="`"))s===l?(s=!1,t.push('"'+o+'"'),o=""):typeof s=="boolean"?s=l:o+=l;else if(!s&&(l===" "||l==="="||l==="<"||l===">")){if(o!==""){if(l==="<"||l===">"){let f=l===">"?"gt":"lt";a<r.length-1&&r[a+1]==="="&&(f+="e",a++);let c=o.split(".");if(c.length>1){let u=c.shift(),m="$"+f;c.unshift(m),c.unshift(u),o=c.join(".")}else o="$"+f+"."+o}t.push(o),o=""}}else o+=l}o!==""&&t.push(o);for(let a=0;a<t.length;a+=2){let l=t[a],f=t[a+1]??!0;if(typeof f=="string"){let c=f.trim();if(c==="")f=!0;else if(/^".*"$/.test(c))f=c.slice(1,-1);else if(c.toLowerCase()==="true")f=!0;else if(c.toLowerCase()==="false")f=!1;else if(!isNaN(Number(c)))f=Number(c);else if(c.startsWith("{")&&c.endsWith("}")||c.startsWith("[")&&c.endsWith("]"))try{f=JSON.parse(c)}catch{}}e[l]=f}return e}var S={"-":"remove","+":"add","~":"update","?":"updateOneOrAdd","^":"toggleOne"},te=["add","find","findOne","update","updateOne","remove","removeOne","updateOneOrAdd","toggleOne","ensureCollection","issetCollection"];function K(r){let e=r.split(`
`).map(i=>i.trim()).filter(i=>i.length>0&&!i.startsWith("#")&&!i.startsWith("//")).join(" ").split(/\s+/).filter(Boolean);if(e.length<2)throw new Error("Invalid query");if(e.length===2&&e[1]==="getCollections")return{db:e[0],op:"getCollections",collection:"",body:""};if(e.length===2&&/^[A-Za-z]/.test(e[0])){let i=N(e[1]);return{db:e[0],op:i.op,collection:i.collection,body:""}}if(e.length===3&&/^[A-Za-z0-9_-]+$/.test(e[2]))return{db:e[0],op:e[1],collection:e[2],body:""};if(e.length>3&&te.includes(e[1]))return{db:e[0],op:e[1],collection:e[2],body:e.slice(3).join(" ")};let t=e.shift(),o="find",s="",n="";if(["!","-","+","~","?","^"].some(i=>e[0].includes(i))||[".",":","{"].some(i=>e[1].includes(i))){let i=e.shift(),a=N(i);o=a.op,s=a.collection}else o=e.shift(),s=e.shift();return n=e.join(" "),{db:t,op:o,collection:s,body:n}}function N(r){let e=r[0],t=r[r.length-1],o="find",s=r;return S[e]&&(o=S[e],s=s.slice(1)),t==="!"&&(o!=="add"&&(o+="One"),s=s.slice(0,-1)),{op:o,collection:s}}function R(r,e=[]){return Object.entries(r).reduce((t,[o,s])=>{let n=[...e,o];return s?typeof s=="object"&&s!==null&&!Array.isArray(s)?[...t,...R(s,n)]:[...t,n]:t},[])}function W(r,e,t,o){return"relations"in o?re(r,t,o):ne(r,e,t,o)}function re(r,e,t){let o={};for(let s in t.relations){let n=t.relations[s];o[s]={path:[n.db||r,n.c||s],...n},delete o[s].db,delete o[s].c}return"select"in t&&(t.select=R(t.select)),{r:{path:[r,e],...t,relations:o}}}function ne(r,e,t,o){return o.fields&&!o.select&&(o.select=o.fields,delete o.fields),"select"in o&&(o.select=[...new Set(R(o.select).map(s=>s[0]).flat())]),{db:r,d:{[e]:{collection:t,...o}}}}var M={s:"search",f:"fields",o:"options",r:"relations",d:"data",e:"select",u:"updater"};function L(r){let{db:e,op:t,collection:o,body:s}=K(r),n=I(s);for(let i of Object.keys(n)){let a=i.split(".");if(a.length===1)continue;let l=n;for(let f=0;f<a.length;f++){let c=a[f];if(f<a.length-1){if(!(c in l)){let u=a[f+1],m=/^\d+$/.test(u);l[c]=m?[]:{}}l=l[c]}else l[c]=n[i],delete n[i]}}for(let i in M)i in n&&(n[M[i]]=n[i],delete n[i]);return(t==="find"||t==="findOne")&&!("search"in n)&&(n.search={}),(t==="update"||t==="remove")&&!("updater"in n)&&"data"in n&&(n.updater=n.data,delete n.data),W(e,t,o,n)}var C=class{constructor(e,t=new Q,o=async()=>({granted:!0,via:"resolver",reason:"no-resolver-match"})){this.dbInstances=e;this.permValidFn=o;this.relation=new oe(e),this.config=t instanceof Q?t:new Q(t)}relation;config;async execute(e,t={_id:"null-null-null"},o=this.config){let s=this._preProcessQuery(e,t);return"err"in s?s.err:await this._runQuery(s.query,t,o)}_preProcessQuery(e,t){let{query:o,err:s}=this._parseQuery(e);if(s)return{err:s};let n=T(o);if(n!==!0)return g.warn("Raw validation failed:",n),{err:n};let i=k(o,t);g.debug("Executed sheet (expanded query):",i);let a=$(i);return a!==!0?(g.warn("VQL validation failed:",a),{err:a}):{query:i}}_parseQuery(e){if(typeof e=="string"||"query"in e){g.info("Incoming string query");let t=typeof e=="string"?e:e.query,o=typeof e=="string"?null:e.var;g.debug(t);try{e=L(t),g.debug("transformed query: ",e)}catch(s){return g.error("Error parsing string query: ",{error:s,msg:s.message}),{err:{err:!0,c:400,msg:`String query parsing error: ${s.message}`}}}o&&(e={...e,var:o}),g.debug("Final string query: ",e)}else g.info("Incoming object query"),g.debug("Raw query: ",e);return{query:e}}async _runQuery(e,t,o=this.config){return"r"in e?await D(this,e,t,o):"d"in e?await U(this,e,t,o):{err:!0,msg:"Invalid query",c:400}}};import ie from"@wxn0brp/db-core/helpers/CollectionManager";import G from"@wxn0brp/db-core/utils/updateFindObject";var se=["ensureCollection","issetCollection","getCollections","removeCollection","add","find","findOne","update","updateOne","updateOneOrAdd","toggleOne","remove","removeOne"];function ae(r,e=!1){let t=s=>{if(!s)throw new Error("Unimplemented method");return s},o={meta:r.meta??{type:"api",version:"0.0.1"}};o.c=s=>new ie(o,s);for(let s of se)o[s]=(...n)=>t(r[s])(...n);return e&&(o.find=async(s,n,i,a,l)=>{let f=await t(r.find)(s,n,i,a,l);return i?.reverse&&f.reverse(),i?.limit!==-1&&f.length>i?.limit&&(f=f.slice(0,i?.limit)),f=f.map(c=>G(c,a||{})),f},o.findOne=async(s,n,i,a)=>{let l=await t(r.findOne)(s,n,i,a);return typeof l!="object"?l:G(l,a||{})}),o}function le(r,e,t={}){let o=t.path||"/VQL",s=t.getUser||(()=>({}));r.post(o,async(n,i)=>{try{let a=await s(n),l=await e.execute(n.body.query,a);return l&&l.err?l:{err:!1,result:l}}catch(a){return i.status(500),{err:!0,msg:a.message}}}),t.dev&&r.get(o+"-query",(n,i)=>{try{return i.json(L(n.query?.query||""))}catch(a){return i.status(500),{err:!0,msg:a.message}}})}function ce(r){return async e=>{let t=await r.hasAccess(e.user._id,e.field,e.p);return{granted:t.granted,via:"gate-warden",reason:t.via}}}var Vt=C;export{le as FF_VQL,Q as VQLConfig,h as VQLLogLevel,g as VQLLogger,C as VQLProcessor,ce as createGwValidFn,ae as createValtheraAdapter,Vt as default};
