import{Relation as te}from"@wxn0brp/db-core";var O=class{hidePath=!1;strictSelect=!1;strictACL=!1;noCheckPermissions=!0;permissionDeniedIfNoUser=!0;constructor(e){e&&Object.assign(this,e)}};var C=null;async function G(r){if(typeof window<"u"&&window.crypto?.subtle){let e=await crypto.subtle.digest("SHA-256",new TextEncoder().encode(r));return[...new Uint8Array(e)].map(n=>n.toString(16).padStart(2,"0")).join("")}else return C||(C=await import("crypto")),C.createHash("sha256").update(r).digest("hex")}async function g(r,e){let n=JSON.stringify(e);return r.hidePath?await G(n):n}function b(r,e=[]){let n=[];for(let o in r){let t=r[o];typeof t=="object"?n.push(...b(t,[...e,o])):n.push({path:e,key:o})}return n}async function K(r,e){let n=Object.keys(e.d)[0],o=e.d[n].collection,t={db:await g(r,e.db),c:o,paths:[]};switch(n){case"f":case"find":case"findOne":let a=e.d[n];t.paths.push({filed:b(a.search),p:2});break;case"add":t.paths.push({c:1});break;case"update":case"updateOne":let i=e.d[n];t.paths.push({filed:b(i.search),p:2}),t.paths.push({filed:b(i.updater),p:4});break;case"remove":case"removeOne":t.paths.push({c:8});break;case"updateOneOrAdd":let s=e.d[n];t.paths.push({c:1}),t.paths.push({filed:b(s.search),p:2}),t.paths.push({filed:b(s.updater),p:4});break;case"ensureCollection":case"getCollections":case"issetCollection":case"removeCollection":t.paths.push({c:16});break}return t.paths=(await Promise.all(t.paths.map(async a=>a.filed?await Promise.all(a.filed.map(async i=>{let s=[e.db,o,...z(i)];return{filed:await g(r,s),path:s,p:a.p}})):a))).flat(),t}function z(r){let e=!1,n=[];for(let o of r.path)e?n.push(o):o.startsWith("$")?o==="$subset"&&(e=!0):n.push(o);return e?n.push(r.key):r.key.startsWith("$")||n.push(r.key),n}async function F(r,e,n,o){if(!o||!n&&r.permissionDeniedIfNoUser)return!1;let t=await K(r,o),a=async(s,l,d,c=[])=>{let u=await e({field:s,path:l,p:d,user:n});if(u.granted)return!0;if(!r.strictACL&&u.via==="entity-404"&&c.length>0){let y=await g(r,c.slice(0,-1));return a(y,c.slice(0,-2),d,c.slice(0,-2))}return!1},i=[];for(let s of t.paths){let l,d,c=[],u=[];"c"in s?(l=await g(r,[o.db,t.c]),d=s.c,u=[o.db,t.c],c=[o.db]):(l=s.filed,d=s.p,u=s.path,c=s.path);let y=await a(l,u,d,c);i.push(y)}return i.every(s=>s)}async function P(r,e,n,o){if(!n&&r.permissionDeniedIfNoUser)return!1;let{path:t,search:a,relations:i,select:s}=o.r,l=async(c,u,y=[])=>{let A=await e({field:c,path:u,p:2,user:n});if(A.granted)return!0;if(!r.strictACL&&A.via==="entity-404"&&y.length>0){let M=await g(r,y.slice(0,-1));return l(M,y.slice(0,-2),y.slice(0,-2))}return!1};if(!await l(await g(r,t),t,t))return!1;let d=b(a||{});for(let c of d){let u=[...t,...c.path,c.key];if(!await l(await g(r,u),u,u))return!1}if(s)for(let c of s){let u=[...t,c];if(!await l(await g(r,u),u,u))return!1}if(i)for(let c in i){let u=i[c];if(!await P(r,e,n,{r:u}))return!1}return!0}function Q(r,e){if(Array.isArray(e))return!r.strictSelect&&e.length===0?void 0:e;if(typeof e=="object"){let n=Object.keys(e);return!r.strictSelect&&n.length===0?void 0:n.filter(o=>!!e[o])}else return r.strictSelect?[]:void 0}function H(r,e){e.select=Q(r,e.select)}function w(r,e){let n=e.path[0];if(!n||!r.dbInstances[n])return{err:!0,msg:`Invalid query - db "${n}" not found`,c:400};if(e.relations)for(let o of Object.values(e.relations)){let t=w(r,o);if(t.err)return t}return{err:!1}}async function E(r,e,n){let o=w(r,e.r);if(o.err)return o;if(!r.config.noCheckPermissions&&!await P(r.config,r.permValidFn,n,e))return{err:!0,msg:"Permission denied",c:403};let t=e.r;H(r.config,t);let{path:a,search:i,relations:s,select:l}=t;return t.many?await r.relation.find(a,i,s,l,t.options):await r.relation.findOne(a,i,s,l)}async function k(r,e,n){if(!e.db||!r.dbInstances[e.db])return{err:!0,msg:`Invalid query - db "${e.db||"undefined"}" not found`,c:400};let o=r.dbInstances[e.db],t=Object.keys(e.d)[0];if(!r.config.noCheckPermissions&&!await F(r.config,r.permValidFn,n,e))return{err:!0,msg:"Permission denied",c:403};if(t==="find"){let a=e.d[t],i=Q(r.config,a.fields||a.select||{});return i&&typeof i=="object"&&Object.keys(i).length!==0&&(a.searchOpts={...a.searchOpts,select:i}),o.find(a.collection,a.search,a.options||{},a.searchOpts)}else if(t==="findOne"||t==="f"){let a=e.d[t],i=Q(r.config,a.fields||a.select||{});return i&&typeof i=="object"&&Object.keys(i).length!==0&&(a.searchOpts={...a.searchOpts,select:i}),o.findOne(a.collection,a.search,a.searchOpts)}else if(t==="add"){let a=e.d[t];return o.add(a.collection,a.data,a.id_gen??!0)}else if(t==="update"){let a=e.d[t];return o.update(a.collection,a.search,a.updater)}else if(t==="updateOne"){let a=e.d[t];return o.updateOne(a.collection,a.search,a.updater)}else if(t==="remove"){let a=e.d[t];return o.remove(a.collection,a.search)}else if(t==="removeOne"){let a=e.d[t];return o.removeOne(a.collection,a.search)}else if(t==="updateOneOrAdd"){let a=e.d[t],i={};return a.add_arg&&(i.add_arg=a.add_arg),a.id_gen&&(i.id_gen=a.id_gen),o.updateOneOrAdd(a.collection,a.search,a.updater,i)}else if(t==="removeCollection"){let a=e.d[t];return o.removeCollection(a.collection)}else if(t==="ensureCollection"){let a=e.d[t];return o.ensureCollection(a.collection)}else if(t==="issetCollection"){let a=e.d[t];return o.issetCollection(a.collection)}else{if(t==="getCollections")return o.getCollections();{let a=t;throw new Error("Unknown operation "+a)}}}var _=class{log(e){let n="";if(e.loggerName&&(n+=`[${e.loggerName}] `),n+="["+e.timestamp+"] ",n+="["+e.level.toUpperCase()+"]",e.level==="DEBUG"){let o=e.data.findIndex(t=>typeof t=="object");if(o>=0){let t=e.data.slice(0,o),a=e.data.slice(o);console.log(n,...t);for(let i of a)typeof i=="object"?console.dir(i,{depth:null}):console.log(i);console.log("[DEBUG];")}else console.log(n,...e.data)}else console.log(n,...e.data)}};var m;(function(r){r[r.ERROR=0]="ERROR",r[r.WARN=1]="WARN",r[r.INFO=2]="INFO",r[r.DEBUG=3]="DEBUG"})(m||(m={}));var V=class{transports;loggerName;logLevel;constructor(e={}){if(this.transports=e.transports??[new _],this.loggerName=e.loggerName??"",e.logLevel){let n=e.logLevel.toUpperCase();typeof m[n]=="number"?this.logLevel=m[n]:this.logLevel=m.ERROR}else this.logLevel=m.ERROR}createEntry(e,n){return{level:e,timestamp:new Date().toISOString(),data:n,loggerName:this.loggerName}}async log(e,n){if(e>this.logLevel)return;let o=this.createEntry(m[e],n);for(let t of this.transports)await t.log(o)}debug(...e){return this.log(m.DEBUG,e)}info(...e){return this.log(m.INFO,e)}warn(...e){return this.log(m.WARN,e)}error(...e){return this.log(m.ERROR,e)}};var J=new V({loggerName:"VQL"}),h=J;function x(r,e){if(typeof r=="object"&&!Array.isArray(r)&&r!==null&&"__"in r){let n=r.__;return e[n]??r}if(typeof r=="string")return r.startsWith("$")?e[r.slice(1)]??r:r;if(Array.isArray(r))return r.map(n=>x(n,e));if(typeof r=="object"&&r!==null){let n={};for(let o in r)n[o]=x(r[o],e);return n}return r}function j(r,e){return r.var={_me:e?.id||e?._id||e,_now:Date.now(),_nowShort:Math.floor(Date.now()/1e3),__now:Date.now().toString(),__nowShort:Math.floor(Date.now()/1e3).toString(),...r.var||{}},r=x(r,r.var),delete r.var,r}function f(r="Bad query"){return{err:!0,msg:r,c:400}}function p(r,e=!0){return typeof r=="object"&&r!==null&&!Array.isArray(r)&&(!e||Object.keys(r).length!==0)}function U(r){return"r"in r&&p(r.r)||"db"in r&&typeof r.db=="string"&&p(r.d)?!0:f("Invalid VQL query structure. Must contain 'r' or 'db' and 'd'.")}function D(r){if(!p(r,!1))return f("The 'relations' property must be an object.");for(let e in r){let n=r[e];if(!p(n))return f(`Relation '${e}' must be an object.`);if(!("path"in n)||!Array.isArray(n.path)||n.path.length!==2)return f(`Relation '${e}' must have a 'path' property with an array of two strings.`);if("search"in n&&!p(n.search,!1))return f(`Relation '${e}' has an invalid 'search' property; it must be an object.`);if("many"in n&&typeof n.many!="boolean")return f(`Relation '${e}' has an invalid 'many' property; it must be a boolean.`);if("options"in n&&!p(n.options,!1))return f(`Relation '${e}' has an invalid 'options' property; it must be an object.`);if("select"in n&&!Array.isArray(n.select))return f(`Relation '${e}' has an invalid 'select' property; it must be an array.`);if("relations"in n){let o=D(n.relations);if(o!==!0)return o}}return!0}function Z(r){let{r:e}=r;if(!("path"in e)||!Array.isArray(e.path)||e.path.length!==2)return f("Relation query 'r' must have a 'path' property with an array of two strings.");if(!p(e.search,!1))return f("Relation query 'r.search' must be an object.");if(!p(e.relations,!1))return f("Relation query 'r' must have a 'relations' object.");let n=D(e.relations);return n!==!0?n:"many"in e&&typeof e.many!="boolean"?f("Relation query 'r.many' must be a boolean."):"options"in e&&!p(e.options,!1)?f("Relation query 'r.options' must be an object."):"select"in e&&typeof e.select!="object"?f("Relation query 'r.select' must be an object or an array."):!0}function X(r){let{d:e}=r,n=Object.keys(e)[0],o=e[n];if(n==="getCollections")return!0;if(typeof o.collection!="string"||o.collection.trim()==="")return f(`CRUD operation '${n}' must specify a non-empty 'collection' string.`);if(n==="issetCollection"||n==="ensureCollection"||n==="removeCollection")return!0;if(n==="add"){let t=e.add;return p(t.data)?"id_gen"in t&&typeof t.id_gen!="boolean"?f("'add' operation 'id_gen' property must be a boolean."):!0:f("'add' operation requires a 'data' object.")}if(n==="find"){let t=e.find;return"search"in t&&!p(t.search,!1)?f("'find' operation 'search' property must be an object."):"limit"in t&&typeof t.limit!="number"?f("'find' operation 'limit' property must be a number."):"fields"in t&&!p(t.fields,!1)&&!Array.isArray(t.fields)?f("'find' operation 'fields' property must be an object or an array."):"select"in t&&!p(t.select,!1)&&!Array.isArray(t.select)?f("'find' operation 'select' property must be an object or an array."):"options"in t&&!p(t.options,!1)?f("'find' operation 'options' property must be an object."):"searchOpts"in t&&!p(t.searchOpts,!1)?f("'find' operation 'searchOpts' property must be an object."):!0}if(n==="findOne"||n==="f"){let t=e.findOne||e.f;return p(t.search,!1)?"fields"in t&&!p(t.fields,!1)&&!Array.isArray(t.fields)?f(`'${n}' operation 'fields' property must be an object or an array.`):"select"in t&&!p(t.select,!1)&&!Array.isArray(t.select)?f(`'${n}' operation 'select' property must be an object or an array.`):"searchOpts"in t&&!p(t.searchOpts,!1)?f(`'${n}' operation 'searchOpts' property must be an object.`):!0:f(`'${n}' operation requires a 'search' object.`)}if(n==="remove"||n==="removeOne"){let t=e.remove||e.removeOne;return p(t.search,!1)?!0:f(`'${n}' operation requires a 'search' object.`)}if(n==="update"||n==="updateOne"){let t=e.update||e.updateOne;return p(t.search,!1)?p(t.updater,!1)?!0:f(`'${n}' operation requires an 'updater' object.`):f(`'${n}' operation requires a 'search' object.`)}if(n==="updateOneOrAdd"){let t=e.updateOneOrAdd;return p(t.search,!1)?p(t.updater,!1)?"add_arg"in t&&!p(t.add_arg,!1)?f("'updateOneOrAdd' operation 'add_arg' property must be an object."):"id_gen"in t&&typeof t.id_gen!="boolean"?f("'updateOneOrAdd' operation 'id_gen' property must be a boolean."):!0:f("'updateOneOrAdd' operation requires an 'updater' object."):f("'updateOneOrAdd' operation requires a 'search' object.")}return f(`Unknown or invalid CRUD operation: '${n}'`)}function T(r){return"r"in r&&p(r.r)?Z(r):"d"in r&&p(r.d)?X(r):f("Query must contain a valid 'r' (relation) or 'd' (database) property.")}var $={"-":"remove","+":"add","~":"update"},Y=["add","find","findOne","update","updateOne","remove","removeOne","updateOneOrAdd","ensureCollection","issetCollection"];function S(r){let e=r.split(`
`).map(i=>i.trim()).filter(i=>i.length>0&&!i.startsWith("#")&&!i.startsWith("//")).join(" ").split(/\s+/).filter(Boolean);if(e.length<2)throw new Error("Invalid query");if(e.length===2&&e[1]==="getCollections")return{db:e[0],op:"getCollections",collection:"",body:""};if(e.length===2&&/^[A-Za-z]/.test(e[0])){let i=I(e[1]);return{db:e[0],op:i.op,collection:i.collection,body:""}}if(e.length===3&&/^[A-Za-z0-9_-]+$/.test(e[2]))return{db:e[0],op:e[1],collection:e[2],body:""};if(e.length>3&&Y.includes(e[1]))return{db:e[0],op:e[1],collection:e[2],body:e.slice(3).join(" ")};let n=e.shift(),o="find",t="",a="";if(["!","-","+","~"].some(i=>e[0].includes(i))||[".",":","{"].some(i=>e[1].includes(i))){let i=e.shift(),s=I(i);o=s.op,t=s.collection}else o=e.shift(),t=e.shift();return a=e.join(" "),{db:n,op:o,collection:t,body:a}}function I(r){let e=r[0],n=r[r.length-1],o="find",t=r;return $[e]&&(o=$[e],t=t.slice(1)),n==="!"&&(o!=="add"&&(o+="One"),t=t.slice(0,-1)),{op:o,collection:t}}function L(r,e=[]){return Object.entries(r).reduce((n,[o,t])=>{let a=[...e,o];return t?typeof t=="object"&&t!==null&&!Array.isArray(t)?[...n,...L(t,a)]:[...n,a]:n},[])}var N={s:"search",f:"fields",o:"options",r:"relations",d:"data",e:"select",u:"updater"};function q(r){let e={},n=[],o="",t=!1,a=!1,i=0;for(let s=0;s<r.length;s++){let l=r[s];if(a)o+=l,a=!1;else if(l==="\\")a=!0;else if(!t&&(l==="{"||l==="["))i++,o+=l;else if(!t&&(l==="}"||l==="]"))i--,o+=l,i===0&&(n.push(o),o="");else if(!i&&(l==="'"||l==='"'||l==="`"))t===l?(t=!1,n.push('"'+o+'"'),o=""):typeof t=="boolean"?t=l:o+=l;else if(!t&&(l===" "||l==="="||l==="<"||l===">")){if(o!==""){if(l==="<"||l===">"){let d=l===">"?"gt":"lt";s<r.length-1&&r[s+1]==="="&&(d+="e",s++);let c=o.split(".");if(c.length>1){let u=c.shift(),y="$"+d;c.unshift(y),c.unshift(u),o=c.join(".")}else o="$"+d+"."+o}n.push(o),o=""}}else o+=l}o!==""&&n.push(o);for(let s=0;s<n.length;s+=2){let l=n[s],d=n[s+1]??!0;if(typeof d=="string"){let c=d.trim();if(c==="")d=!0;else if(/^".*"$/.test(c))d=c.slice(1,-1);else if(c.toLowerCase()==="true")d=!0;else if(c.toLowerCase()==="false")d=!1;else if(!isNaN(Number(c)))d=Number(c);else if(c.startsWith("{")&&c.endsWith("}")||c.startsWith("[")&&c.endsWith("]"))try{d=JSON.parse(c)}catch{}}e[l]=d}return e}function ee(r,e,n,o){if("relations"in o){let a={};for(let i in o.relations){let s=o.relations[i];a[i]={path:[s.db||r,s.c||i],...s},delete a[i].db,delete a[i].c}return"select"in o&&(o.select=L(o.select)),{r:{path:[r,n],...o,relations:a}}}else return o.fields&&!o.select&&(o.select=o.fields,delete o.fields),"select"in o&&(o.select=[...new Set(L(o.select).map(a=>a[0]).flat())]),{db:r,d:{[e]:{collection:n,...o}}}}function R(r){let{db:e,op:n,collection:o,body:t}=S(r),a=q(t);for(let i of Object.keys(a)){let s=i.split(".");if(s.length===1)continue;let l=a;for(let d=0;d<s.length;d++){let c=s[d];d<s.length-1?(c in l||(l[c]={}),l=l[c]):(l[c]=a[i],delete a[i])}}for(let i in N)i in a&&(a[N[i]]=a[i],delete a[i]);return(n==="find"||n==="findOne")&&!("search"in a)&&(a.search={}),(n==="update"||n==="remove")&&!("updater"in a)&&"data"in a&&(a.updater=a.data,delete a.data),ee(e,n,o,a)}var v=class{constructor(e,n=new O,o=async()=>({granted:!0,via:""})){this.dbInstances=e;this.permValidFn=o;this.relation=new te(e),this.config=n instanceof O?n:new O(n)}relation;config;async execute(e,n={_id:"null-null-null"}){let o=this._preProcessQuery(e,n);return"err"in o?o.err:await this._runQuery(o.query,n)}_preProcessQuery(e,n){let{query:o,err:t}=this._parseQuery(e);if(t)return{err:t};let a=U(o);if(a!==!0)return h.warn("Raw validation failed:",a),{err:a};let i=j(o,n);h.debug("Executed sheet (expanded query):",i);let s=T(i);return s!==!0?(h.warn("VQL validation failed:",s),{err:s}):{query:i}}_parseQuery(e){if(typeof e=="string"||"query"in e){h.info("Incoming string query");let n=typeof e=="string"?e:e.query,o=typeof e=="string"?null:e.var;h.debug(n);try{e=R(n),h.debug("transformed query: ",e)}catch(t){return h.error("Error parsing string query: ",{error:t,msg:t.message}),{err:{err:!0,c:400,msg:`String query parsing error: ${t.message}`}}}o&&(e={...e,var:o}),h.debug("Final string query: ",e)}else h.info("Incoming object query"),h.debug("Raw query: ",e);return{query:e}}async _runQuery(e,n){return"r"in e?await E(this,e,n):"d"in e?await k(this,e,n):{err:!0,msg:"Invalid query",c:400}}};import re from"@wxn0brp/db-core/helpers/CollectionManager";import W from"@wxn0brp/db-core/utils/updateFindObject";var ne=["ensureCollection","issetCollection","getCollections","removeCollection","add","find","findOne","update","updateOne","updateOneOrAdd","remove","removeOne"];function oe(r,e=!1){let n=t=>{if(!t)throw new Error("Unimplemented method");return t},o={meta:r.meta??{type:"api",version:"0.0.1"}};o.c=t=>new re(o,t);for(let t of ne)o[t]=(...a)=>n(r[t])(...a);return e&&(o.find=async(t,a,i,s,l)=>{let d=await n(r.find)(t,a,i,s,l);return i?.reverse&&d.reverse(),i?.max!==-1&&d.length>i?.max&&(d=d.slice(0,i?.max)),d=d.map(c=>W(c,s||{})),d},o.findOne=async(t,a,i,s)=>{let l=await n(r.findOne)(t,a,i,s);return typeof l!="object"?l:W(l,s||{})}),o}function ae(r,e,n={}){let o=n.path||"/VQL",t=n.getUser||(()=>({}));r.post(o,async(a,i)=>{try{let s=await t(a),l=await e.execute(a.body.query,s);return l&&l.err?l:{err:!1,result:l}}catch(s){return i.status(500),{err:!0,msg:s.message}}}),n.dev&&r.get(o+"-query",(a,i)=>{try{return i.json(R(a.query?.query||""))}catch(s){return i.status(500),{err:!0,msg:s.message}}})}function ie(r){return async e=>r.hasAccess(e.user.id,e.field,e.p)}var ft=v;export{ae as FF_VQL,O as VQLConfig,m as VQLLogLevel,h as VQLLogger,v as VQLProcessor,ie as createGwValidFn,oe as createValtheraAdapter,ft as default};
